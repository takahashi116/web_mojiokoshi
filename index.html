<!-- index.html -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>文字起こし（話者分離） - Gemini</title>
  <link rel="stylesheet" href="./styles.css?v=20251224" />
  <!-- Google Identity Services (OAuth) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <!-- Google API loader (Picker) -->
  <script src="https://apis.google.com/js/api.js" async defer></script>
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="brand-mark">G</div>
        <div class="brand-text">
          <div class="brand-title">文字起こし（話者分離）</div>
          <div class="brand-sub">Gemini + Google Drive</div>
        </div>
      </div>
      <div class="topbar-actions">
        <a class="link" href="https://ai.google.dev/gemini-api/docs/files" target="_blank" rel="noreferrer">Files API</a>
        <a class="link" href="https://developers.google.com/picker" target="_blank" rel="noreferrer">Drive Picker</a>
      </div>
    </header>

    <main class="layout">
      <section class="card">
        <h2>1. API キー設定</h2>
        <p class="muted">
          Gemini API キーはブラウザの localStorage に保存されます（端末内のみ）。
        </p>

        <div class="grid-2">
          <div class="field">
            <label for="apiKeyInput">Gemini API Key</label>
            <div class="input-row">
              <input id="apiKeyInput" type="password" inputmode="text" autocomplete="off" placeholder="AI... から始まるキー" />
              <button id="toggleKeyBtn" class="btn btn-ghost" type="button" aria-label="表示切替">表示</button>
            </div>
            <div class="hint" id="keyStatus">未設定</div>
          </div>

          <div class="field">
            <label for="modelSelect">モデル</label>
            <select id="modelSelect">
              <option value="gemini-3-flash-preview">gemini-3-flash-preview（推奨）</option>
              <option value="gemini-3-pro-preview">gemini-3-pro-preview</option>
              <option value="gemini-2.5-flash">gemini-2.5-flash</option>
              <option value="gemini-2.5-pro">gemini-2.5-pro</option>
            </select>
            <div class="hint">JSON 出力（application/json）を要求します。</div>
          </div>
        </div>

        <div class="grid-2">
          <div class="field">
            <label for="speakerCountSelect">話者数（最大 10）</label>
            <select id="speakerCountSelect"></select>
            <div class="hint">ここで選んだ人数がプロンプトに動的反映されます。</div>
          </div>

          <div class="field">
            <label>保存</label>
            <button id="saveKeyBtn" class="btn" type="button">このキーを保存</button>
            <div class="hint">保存後、ページを再読み込みしても保持されます。</div>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>2. 音声/動画ファイルを選択</h2>

        <div class="tabs">
          <button id="tabDrive" class="tab is-active" type="button">Google Drive から選択（推奨）</button>
          <button id="tabLocal" class="tab" type="button">端末から選択</button>
        </div>

        <div id="drivePanel" class="panel">
          <div class="grid-2">
            <div class="field">
              <label>Google Drive 接続</label>
              <button id="driveConnectBtn" class="btn" type="button">Google にログイン</button>
              <div class="hint" id="driveStatus">未接続</div>
            </div>

            <div class="field">
              <label>検索しやすいようにフォルダ固定（任意）</label>
              <div class="btn-row">
                <button id="pickFolderBtn" class="btn btn-ghost" type="button" disabled>フォルダを固定</button>
                <button id="clearFolderBtn" class="btn btn-ghost" type="button" disabled>固定を解除</button>
              </div>
              <div class="hint" id="pinnedFolderLabel">固定なし</div>
            </div>
          </div>

          <div class="field">
            <label>ファイル選択（音声/動画）</label>
            <button id="pickFileBtn" class="btn" type="button" disabled>Drive からファイルを選ぶ</button>
            <div class="hint" id="selectedFileName">未選択</div>
          </div>
        </div>

        <div id="localPanel" class="panel is-hidden">
          <div class="field">
            <label for="localFileInput">端末から選択</label>
            <input id="localFileInput" type="file" accept="audio/*,video/*" />
            <div class="hint" id="localFileName">未選択</div>
          </div>
          <p class="muted">
            iPhone は常に Files API（アップロード）を使う設定のため、端末選択でも大きめのファイルに比較的強い構成です。
          </p>
        </div>
      </section>

      <section class="card">
        <h2>3. 文字起こし実行</h2>

        <div class="action-row">
          <button id="startBtn" class="btn btn-primary" type="button" disabled>文字起こし開始</button>
          <div class="progress">
            <div class="progress-bar" id="progressBar" style="width:0%"></div>
          </div>
        </div>
        <div class="hint" id="progressText">待機中</div>

        <details class="details">
          <summary>現在のプロンプト（確認用）</summary>
          <pre id="promptPreview" class="codebox"></pre>
        </details>
      </section>

      <section class="card">
        <h2>4. 結果</h2>

        <div class="result-grid">
          <div>
            <h3>チャット表示（話者別）</h3>
            <div id="chatThread" class="chat-thread">
              <div class="muted">まだ結果はありません。</div>
            </div>
          </div>

          <div>
            <div class="result-header">
              <h3>JSON（生データ）</h3>
              <button id="downloadJsonBtn" class="btn btn-ghost" type="button" disabled>JSON をダウンロード</button>
            </div>
            <pre id="jsonOutput" class="codebox">まだ結果はありません。</pre>
          </div>
        </div>
      </section>

      <footer class="footer">
        <div class="muted">
          注意: API キー・OAuth はクライアント実行のため、組織内公開前提で運用してください。
        </div>
      </footer>
    </main>
  </div>

  <script src="./app.js?v=20251224" defer></script>
</body>
</html>
